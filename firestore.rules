
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user has a specific role
    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // Users can read their own profile, and admins/owners can read anyone's.
    // Users can create their own profile, but only update their own.
    // Owners can update anyone's role.
    match /users/{userId} {
      allow read: if request.auth.uid == userId || hasRole('admin') || hasRole('owner');
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId 
                    || (hasRole('owner') && !('role' in request.resource.data.diff(resource.data)));
      
      // Separate rule for role changes, only by owner, and not on themselves
      allow update: if hasRole('owner') 
                      && 'role' in request.resource.data.diff(resource.data)
                      && request.auth.uid != userId;
    }
    
    // Any authenticated user can read their own push subscriptions.
    // They can create/delete their own subscriptions.
    match /users/{userId}/pushSubscriptions/{subscriptionId} {
      allow read, create, delete: if request.auth.uid == userId;
    }
    
    // Shifts can only be read by the assigned user, an admin, or an owner.
    // Admins/owners can create, update, and delete any shift.
    match /shifts/{shiftId} {
      allow read: if request.auth.uid == resource.data.userId || hasRole('admin') || hasRole('owner');
      allow create, delete: if hasRole('admin') || hasRole('owner');

      // Users can only update the status of their own shifts.
      // Admins/owners can update any field.
      allow update: if (request.auth.uid == resource.data.userId 
                      && request.resource.data.keys().hasOnly(['status', 'notes']))
                    || hasRole('admin') || hasRole('owner');
    }
    
    // Any authenticated user can view the list of projects and their attached files.
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow create, delete: if hasRole('admin') || hasRole('owner');

      match /files/{fileId} {
        allow read: if request.auth != null;
        // Any authenticated user can upload files
        allow create: if request.auth != null;
        // Only the uploader or an admin/owner can delete files
        allow delete: if request.auth.uid == resource.data.uploaderId || hasRole('admin') || hasRole('owner');
      }
    }

    // Any authenticated user can read announcements.
    // Only admins/owners can create, update, or delete them.
    match /announcements/{announcementId} {
        allow read: if request.auth != null;
        allow create, update, delete: if hasRole('admin') || hasRole('owner');
    }
    
    // No one should be able to read/write the settings directly from the client.
    // This will be handled by a secure Cloud Function.
    match /settings/{docId} {
      allow read, write: if false;
    }
  }
}

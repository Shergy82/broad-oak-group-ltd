
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to get the role of the currently authenticated user.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    // Helper function to check if the user has a privileged role (admin or owner).
    function isPrivileged(userId) {
      let userRole = getUserRole(userId);
      return userRole == 'admin' || userRole == 'owner';
    }
    
    // Helper function to check if the user is the designated owner of the app.
    function isOwner(userId) {
      return getUserRole(userId) == 'owner';
    }

    // /users/{userId}
    match /users/{userId} {
      // Any user can create their own user document upon signing up.
      allow create: if request.auth.uid == userId;
      
      // A user can read their own profile. Admins/owners can read any profile.
      allow read: if request.auth.uid == userId || isPrivileged(request.auth.uid);
      
      // A user can update their own profile data. Owners can update any user's role.
      allow update: if request.auth.uid == userId || isOwner(request.auth.uid);
      
      // No user should be able to delete user documents directly.
      allow delete: if false;
      
      // Subscriptions subcollection
      match /pushSubscriptions/{subscriptionId} {
        // A user can manage their own push notification subscriptions.
        allow read, write, delete: if request.auth.uid == userId;
      }
    }
    
    // /shifts/{shiftId}
    match /shifts/{shiftId} {
        // Admins and owners can create, update, and delete any shift.
        allow create, delete: if isPrivileged(request.auth.uid);
        
        // Users can read any shift (for team schedule view).
        // Admins/Owners can update any shift.
        // A regular user can only update their own assigned shifts (e.g., changing status).
        allow read, update: if request.auth != null && 
                              (isPrivileged(request.auth.uid) || resource.data.userId == request.auth.uid);
    }
    
    // /settings/notifications
    match /settings/notifications {
      // Any authenticated user can read the master toggle state.
      allow read: if request.auth != null;
      
      // Only the user with the 'owner' role can change it.
      allow write: if isOwner(request.auth.uid);
    }

    // /projects/{projectId}
    match /projects/{projectId} {
        // Any authenticated user can view the list of projects.
        allow read: if request.auth != null;
        
        // Only admins or owners can create, update, or delete projects.
        allow create, update, delete: if isPrivileged(request.auth.uid);
        
        // Files subcollection
        match /files/{fileId} {
            // Any authenticated user can view the file list for any project.
            allow read: if request.auth != null;
            
            // Any authenticated user can upload a file (create a file document).
            allow create: if request.auth != null;
            
            // Only the user who uploaded the file, or an admin/owner, can delete it.
            allow delete: if request.auth != null && 
                          (isPrivileged(request.auth.uid) || resource.data.uploaderId == request.auth.uid);
            
            // File documents are not designed to be updated.
            allow update: if false;
        }
    }
    
    // /announcements/{announcementId}
    match /announcements/{announcementId} {
        // Any authenticated user can read announcements.
        allow read: if request.auth != null;
        
        // Only admins or owners can create, update, or delete announcements.
        allow create, update, delete: if isPrivileged(request.auth.uid);
    }
    
  }
}

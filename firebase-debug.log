[debug] [2025-07-05T15:51:15.315Z] ----------------------------------------------------------------------
[debug] [2025-07-05T15:51:15.323Z] Command:       /nix/store/rbdrkcs5kkwpalxcd7c6bnm33lk2955n-nodejs-20.19.0/bin/node /nix/store/fprgfkwna33crhc86jqbf5878piivvgw-firebase-tools-14.7.0/lib/node_modules/firebase-tools/lib/bin/firebase.js emulators:start --project=demo-app --only=auth,firestore
[debug] [2025-07-05T15:51:15.327Z] CLI Version:   14.7.0
[debug] [2025-07-05T15:51:15.327Z] Platform:      linux
[debug] [2025-07-05T15:51:15.328Z] Node Version:  v20.19.0
[debug] [2025-07-05T15:51:15.328Z] Time:          Sat Jul 05 2025 15:51:15 GMT+0000 (Coordinated Universal Time)
[debug] [2025-07-05T15:51:15.329Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-07-05T15:51:17.403Z] openjdk version "21.0.5" 2024-10-15
OpenJDK Runtime Environment (build 21.0.5+1-nixos)
OpenJDK 64-Bit Server VM (build 21.0.5+1-nixos, mixed mode, sharing)

[debug] [2025-07-05T15:51:17.491Z] Parsed Java major version: 21
[info] i  emulators: Starting emulators: firestore {"metadata":{"emulator":{"name":"hub"},"message":"Starting emulators: firestore"}}
[info] i  emulators: Detected demo project ID "demo-app", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail. {"metadata":{"emulator":{"name":"hub"},"message":"Detected demo project ID \"demo-app\", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail."}}
[warn] ⚠  auth: Not starting the auth emulator, make sure you have run firebase init. {"metadata":{"emulator":{"name":"auth"},"message":"Not starting the auth emulator, make sure you have run firebase init."}}
[warn] ⚠  hub: Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400 {"metadata":{"emulator":{"name":"hub"},"message":"Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400"}}
[warn] ⚠  hub: Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"hub"},"message":"Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  hub: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"hub"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  ui: Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000 {"metadata":{"emulator":{"name":"ui"},"message":"Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000"}}
[warn] ⚠  ui: Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"ui"},"message":"Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  ui: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"ui"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  logging: Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500 {"metadata":{"emulator":{"name":"logging"},"message":"Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500"}}
[warn] ⚠  logging: Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"logging"},"message":"Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  logging: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"logging"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore: Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080"}}
[warn] ⚠  firestore: Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore.websocket: Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150"}}
[warn] ⚠  firestore: Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[debug] [2025-07-05T15:51:17.552Z] assigned listening specs for emulators {"user":{"hub":[{"address":"127.0.0.1","family":"IPv4","port":4400}],"ui":[{"address":"127.0.0.1","family":"IPv4","port":4000}],"logging":[{"address":"127.0.0.1","family":"IPv4","port":4500}],"firestore":[{"address":"127.0.0.1","family":"IPv4","port":8080}],"firestore.websocket":[{"address":"127.0.0.1","family":"IPv4","port":9150}]},"metadata":{"message":"assigned listening specs for emulators"}}
[debug] [2025-07-05T15:51:17.563Z] [hub] writing locator at /tmp/hub-demo-app.json
[debug] [2025-07-05T15:51:17.594Z] Ignoring unsupported arg: auto_download {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: auto_download"}}
[debug] [2025-07-05T15:51:17.594Z] Ignoring unsupported arg: single_project_mode_error {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: single_project_mode_error"}}
[debug] [2025-07-05T15:51:17.595Z] Starting Firestore Emulator with command {"binary":"java","args":["-Dgoogle.cloud_firestore.debug_log_level=FINE","-Duser.language=en","-jar","/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar","--host","127.0.0.1","--port",8080,"--websocket_port",9150,"--project_id","demo-app","--rules","/home/user/studio/firestore.rules","--single_project_mode",true],"optionalArgs":["port","webchannel_port","host","rules","websocket_port","functions_emulator","seed_from_export","project_id","single_project_mode"],"joinArgs":false,"shell":false,"port":8080} {"metadata":{"emulator":{"name":"firestore"},"message":"Starting Firestore Emulator with command {\"binary\":\"java\",\"args\":[\"-Dgoogle.cloud_firestore.debug_log_level=FINE\",\"-Duser.language=en\",\"-jar\",\"/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar\",\"--host\",\"127.0.0.1\",\"--port\",8080,\"--websocket_port\",9150,\"--project_id\",\"demo-app\",\"--rules\",\"/home/user/studio/firestore.rules\",\"--single_project_mode\",true],\"optionalArgs\":[\"port\",\"webchannel_port\",\"host\",\"rules\",\"websocket_port\",\"functions_emulator\",\"seed_from_export\",\"project_id\",\"single_project_mode\"],\"joinArgs\":false,\"shell\":false,\"port\":8080}"}}
[info] i  firestore: Firestore Emulator logging to firestore-debug.log {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator logging to firestore-debug.log"}}
[debug] [2025-07-05T15:51:29.491Z] Jul 05, 2025 3:51:29 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start
INFO: Started WebSocket server on ws://127.0.0.1:9150
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:51:29 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start\nINFO: Started WebSocket server on ws://127.0.0.1:9150\n"}}
[debug] [2025-07-05T15:51:29.697Z] API endpoint: http://127.0.0.1:8080
If you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:

   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080

If you are running a Firestore in Datastore Mode project, run:

   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080

Note: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.
Dev App Server is now running.

 {"metadata":{"emulator":{"name":"firestore"},"message":"API endpoint: http://127.0.0.1:8080\nIf you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:\n\n   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080\n\nIf you are running a Firestore in Datastore Mode project, run:\n\n   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080\n\nNote: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.\nDev App Server is now running.\n\n"}}
[info] ✔  firestore: Firestore Emulator UI websocket is running on 9150. {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator UI websocket is running on 9150."}}
[debug] [2025-07-05T15:51:29.980Z] Could not find VSCode notification endpoint: FetchError: request to http://localhost:40001/vscode/notify failed, reason: connect ECONNREFUSED 127.0.0.1:40001. If you are not running the Firebase Data Connect VSCode extension, this is expected and not an issue.
[info] 
┌─────────────────────────────────────────────────────────────┐
│ ✔  All emulators ready! It is now safe to connect your app. │
│ i  View Emulator UI at http://127.0.0.1:4000/               │
└─────────────────────────────────────────────────────────────┘

┌───────────┬────────────────┬─────────────────────────────────┐
│ Emulator  │ Host:Port      │ View in Emulator UI             │
├───────────┼────────────────┼─────────────────────────────────┤
│ Firestore │ 127.0.0.1:8080 │ http://127.0.0.1:4000/firestore │
└───────────┴────────────────┴─────────────────────────────────┘
  Emulator Hub host: 127.0.0.1 port: 4400
  Other reserved ports: 4500, 9150

Issues? Report them at https://github.com/firebase/firebase-tools/issues and attach the *-debug.log files.
 
[debug] [2025-07-05T15:51:54.372Z] Jul 05, 2025 3:51:54 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:51:54 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T15:54:08.562Z] Jul 05, 2025 3:54:08 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:54:08 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T15:54:08.885Z] Jul 05, 2025 3:54:08 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:54:08 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T15:54:09.378Z] Jul 05, 2025 3:54:09 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:54:09 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T15:54:09.776Z] Jul 05, 2025 3:54:09 PM io.grpc.netty.NettyServerTransport notifyTerminated
INFO: Transport failed
io.netty.handler.codec.http2.Http2Exception: Unexpected HTTP/1.x request: GET / 
	at io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:315)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)
	at io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:1583)

 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:54:09 PM io.grpc.netty.NettyServerTransport notifyTerminated\nINFO: Transport failed\nio.netty.handler.codec.http2.Http2Exception: Unexpected HTTP/1.x request: GET / \n\tat io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:315)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)\n\tat io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)\n\tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n\n"}}
[debug] [2025-07-05T15:54:09.961Z] Jul 05, 2025 3:54:09 PM io.grpc.netty.NettyServerTransport notifyTerminated
INFO: Transport failed
io.netty.handler.codec.http2.Http2Exception: HTTP/2 client preface string missing or corrupt. Hex dump for received bytes: 16030105a8010005a40303f5b6050c560cb32f29fa3a7adf
	at io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:319)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)
	at io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:1583)

 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 3:54:09 PM io.grpc.netty.NettyServerTransport notifyTerminated\nINFO: Transport failed\nio.netty.handler.codec.http2.Http2Exception: HTTP/2 client preface string missing or corrupt. Hex dump for received bytes: 16030105a8010005a40303f5b6050c560cb32f29fa3a7adf\n\tat io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:319)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)\n\tat io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)\n\tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n\n"}}
[debug] [2025-07-05T16:03:15.637Z] Jul 05, 2025 4:03:15 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
Jul 05, 2025 4:03:15 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 4:03:15 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\nJul 05, 2025 4:03:15 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-07-05T17:03:14.204Z] Jul 05, 2025 5:03:14 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 5:03:14 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-07-05T19:40:17.362Z] ----------------------------------------------------------------------
[debug] [2025-07-05T19:40:17.376Z] Command:       /nix/store/rbdrkcs5kkwpalxcd7c6bnm33lk2955n-nodejs-20.19.0/bin/node /nix/store/fprgfkwna33crhc86jqbf5878piivvgw-firebase-tools-14.7.0/lib/node_modules/firebase-tools/lib/bin/firebase.js emulators:start --project=demo-app --only=auth,firestore
[debug] [2025-07-05T19:40:17.383Z] CLI Version:   14.7.0
[debug] [2025-07-05T19:40:17.384Z] Platform:      linux
[debug] [2025-07-05T19:40:17.386Z] Node Version:  v20.19.0
[debug] [2025-07-05T19:40:17.386Z] Time:          Sat Jul 05 2025 19:40:17 GMT+0000 (Coordinated Universal Time)
[debug] [2025-07-05T19:40:17.387Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-07-05T19:40:17.400Z] >>> [apiv2][query] GET https://firebase-public.firebaseio.com/cli.json [none]
[debug] [2025-07-05T19:40:20.384Z] <<< [apiv2][status] GET https://firebase-public.firebaseio.com/cli.json 200
[debug] [2025-07-05T19:40:20.397Z] <<< [apiv2][body] GET https://firebase-public.firebaseio.com/cli.json {"cloudBuildErrorAfter":1594252800000,"cloudBuildWarnAfter":1590019200000,"defaultNode10After":1594252800000,"minVersion":"3.0.5","node8DeploysDisabledAfter":1613390400000,"node8RuntimeDisabledAfter":1615809600000,"node8WarnAfter":1600128000000}
[debug] [2025-07-05T19:40:21.101Z] openjdk version "21.0.5" 2024-10-15

[debug] [2025-07-05T19:40:21.102Z] OpenJDK Runtime Environment (build 21.0.5+1-nixos)
OpenJDK 64-Bit Server VM (build 21.0.5+1-nixos, mixed mode, sharing)

[debug] [2025-07-05T19:40:21.158Z] Parsed Java major version: 21
[info] i  emulators: Starting emulators: firestore {"metadata":{"emulator":{"name":"hub"},"message":"Starting emulators: firestore"}}
[info] i  emulators: Detected demo project ID "demo-app", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail. {"metadata":{"emulator":{"name":"hub"},"message":"Detected demo project ID \"demo-app\", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail."}}
[warn] ⚠  auth: Not starting the auth emulator, make sure you have run firebase init. {"metadata":{"emulator":{"name":"auth"},"message":"Not starting the auth emulator, make sure you have run firebase init."}}
[warn] ⚠  hub: Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400 {"metadata":{"emulator":{"name":"hub"},"message":"Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400"}}
[warn] ⚠  hub: Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"hub"},"message":"Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  hub: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"hub"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  ui: Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000 {"metadata":{"emulator":{"name":"ui"},"message":"Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000"}}
[warn] ⚠  ui: Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"ui"},"message":"Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  ui: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"ui"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  logging: Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500 {"metadata":{"emulator":{"name":"logging"},"message":"Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500"}}
[warn] ⚠  logging: Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"logging"},"message":"Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  logging: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"logging"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore: Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080"}}
[warn] ⚠  firestore: Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore.websocket: Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150"}}
[warn] ⚠  firestore: Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[debug] [2025-07-05T19:40:21.178Z] assigned listening specs for emulators {"user":{"hub":[{"address":"127.0.0.1","family":"IPv4","port":4400}],"ui":[{"address":"127.0.0.1","family":"IPv4","port":4000}],"logging":[{"address":"127.0.0.1","family":"IPv4","port":4500}],"firestore":[{"address":"127.0.0.1","family":"IPv4","port":8080}],"firestore.websocket":[{"address":"127.0.0.1","family":"IPv4","port":9150}]},"metadata":{"message":"assigned listening specs for emulators"}}
[debug] [2025-07-05T19:40:21.193Z] [hub] writing locator at /tmp/hub-demo-app.json
[debug] [2025-07-05T19:40:21.224Z] Ignoring unsupported arg: auto_download {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: auto_download"}}
[debug] [2025-07-05T19:40:21.224Z] Ignoring unsupported arg: single_project_mode_error {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: single_project_mode_error"}}
[debug] [2025-07-05T19:40:21.224Z] Starting Firestore Emulator with command {"binary":"java","args":["-Dgoogle.cloud_firestore.debug_log_level=FINE","-Duser.language=en","-jar","/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar","--host","127.0.0.1","--port",8080,"--websocket_port",9150,"--project_id","demo-app","--rules","/home/user/studio/firestore.rules","--single_project_mode",true],"optionalArgs":["port","webchannel_port","host","rules","websocket_port","functions_emulator","seed_from_export","project_id","single_project_mode"],"joinArgs":false,"shell":false,"port":8080} {"metadata":{"emulator":{"name":"firestore"},"message":"Starting Firestore Emulator with command {\"binary\":\"java\",\"args\":[\"-Dgoogle.cloud_firestore.debug_log_level=FINE\",\"-Duser.language=en\",\"-jar\",\"/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar\",\"--host\",\"127.0.0.1\",\"--port\",8080,\"--websocket_port\",9150,\"--project_id\",\"demo-app\",\"--rules\",\"/home/user/studio/firestore.rules\",\"--single_project_mode\",true],\"optionalArgs\":[\"port\",\"webchannel_port\",\"host\",\"rules\",\"websocket_port\",\"functions_emulator\",\"seed_from_export\",\"project_id\",\"single_project_mode\"],\"joinArgs\":false,\"shell\":false,\"port\":8080}"}}
[info] i  firestore: Firestore Emulator logging to firestore-debug.log {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator logging to firestore-debug.log"}}
[debug] [2025-07-05T19:40:29.153Z] Jul 05, 2025 7:40:28 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start
INFO: Started WebSocket server on ws://127.0.0.1:9150
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 7:40:28 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start\nINFO: Started WebSocket server on ws://127.0.0.1:9150\n"}}
[debug] [2025-07-05T19:40:29.312Z] API endpoint: http://127.0.0.1:8080
If you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:

   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080

If you are running a Firestore in Datastore Mode project, run:
 {"metadata":{"emulator":{"name":"firestore"},"message":"API endpoint: http://127.0.0.1:8080\nIf you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:\n\n   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080\n\nIf you are running a Firestore in Datastore Mode project, run:\n"}}
[debug] [2025-07-05T19:40:29.313Z] 
   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080

Note: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.
Dev App Server is now running.

 {"metadata":{"emulator":{"name":"firestore"},"message":"\n   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080\n\nNote: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.\nDev App Server is now running.\n\n"}}
[info] ✔  firestore: Firestore Emulator UI websocket is running on 9150. {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator UI websocket is running on 9150."}}
[debug] [2025-07-05T19:40:29.591Z] Could not find VSCode notification endpoint: FetchError: request to http://localhost:40001/vscode/notify failed, reason: connect ECONNREFUSED 127.0.0.1:40001. If you are not running the Firebase Data Connect VSCode extension, this is expected and not an issue.
[info] 
┌─────────────────────────────────────────────────────────────┐
│ ✔  All emulators ready! It is now safe to connect your app. │
│ i  View Emulator UI at http://127.0.0.1:4000/               │
└─────────────────────────────────────────────────────────────┘

┌───────────┬────────────────┬─────────────────────────────────┐
│ Emulator  │ Host:Port      │ View in Emulator UI             │
├───────────┼────────────────┼─────────────────────────────────┤
│ Firestore │ 127.0.0.1:8080 │ http://127.0.0.1:4000/firestore │
└───────────┴────────────────┴─────────────────────────────────┘
  Emulator Hub host: 127.0.0.1 port: 4400
  Other reserved ports: 4500, 9150

Issues? Report them at https://github.com/firebase/firebase-tools/issues and attach the *-debug.log files.
 
[debug] [2025-07-05T19:40:54.346Z] Jul 05, 2025 7:40:54 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 7:40:54 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T19:40:54.706Z] Jul 05, 2025 7:40:54 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 7:40:54 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T20:51:41.844Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T20:51:41.844Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    // Helper function to get a user's role from their profile\n    function getUserRole(userId) {\n      return get(/databases/$(database)/documents/users/$(userId)).data.role;\n    }\n    \n    // Helper function to check if a user is an admin or owner\n    function isPrivilegedUser(userId) {\n      let role = getUserRole(userId);\n      return role == 'admin' || role == 'owner';\n    }\n    \n    // Users can read any profile, but only edit their own.\n    // Admins can edit any profile. Owners can't be demoted.\n    match /users/{userId} {\n      allow read: if request.auth.uid != null;\n      allow create: if request.auth.uid == userId;\n      allow update: if request.auth.uid == userId || (isPrivilegedUser(request.auth.uid) && getUserRole(userId) != 'owner');\n    }\n\n    // Shifts can be read by any user.\n    // They are created/updated/deleted by admins/owners.\n    // An assigned user can update their own shift's status.\n    match /shifts/{shiftId} {\n      allow read: if request.auth.uid != null;\n      allow create, delete: if isPrivilegedUser(request.auth.uid);\n      allow update: if isPrivilegedUser(request.auth.uid) || request.auth.uid == resource.data.userId;\n    }\n\n    // Projects can be read by any user.\n    // They are managed by admins/owners.\n    match /projects/{projectId} {\n      allow read: if request.auth.uid != null;\n      allow create, update, delete: if isPrivilegedUser(request.auth.uid);\n\n      // Files within a project can be read by anyone.\n      // Any authenticated user can upload a file to a project.\n      // Only the uploader or an admin can delete a file.\n      match /files/{fileId} {\n        allow read: if request.auth.uid != null;\n        allow create: if request.auth.uid != null;\n        allow delete: if isPrivilegedUser(request.auth.uid) || request.auth.uid == resource.data.uploaderId;\n      }\n    }\n    \n    // Announcements can be read by any user.\n    // They are managed by admins/owners.\n    match /announcements/{announcementId} {\n        allow read: if request.auth.uid != null;\n        allow create, update, delete: if isPrivilegedUser(request.auth.uid);\n    }\n    \n    // Health & Safety files can be read by any user.\n    // They can only be created or deleted by admins/owners.\n    match /health_and_safety_files/{fileId} {\n        allow read: if request.auth.uid != null;\n        allow create, delete: if isPrivilegedUser(request.auth.uid);\n    }\n  }\n}"}]}}
[debug] [2025-07-05T20:51:42.067Z] Jul 05, 2025 8:51:42 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 8:51:42 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T20:51:43.235Z] Jul 05, 2025 8:51:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 8:51:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-07-05T20:51:49.903Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T20:51:49.912Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T20:53:40.991Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T20:53:40.993Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check for admin/owner roles\n    function isPrivileged(userId) {\n      // Check if the user document exists and has a role field before accessing it.\n      return exists(/databases/$(database)/documents/users/$(userId)) &&\n             get(/databases/$(database)/documents/users/$(userId)).data.role in ['admin', 'owner'];\n    }\n    \n    // Users can only read/update their own profile or be managed by privileged users.\n    match /users/{userId} {\n      allow read, update: if request.auth.uid == userId || isPrivileged(request.auth.uid);\n      // Anyone can create their own user document upon sign-up.\n      allow create: if request.auth.uid == userId;\n      \n      // Users can manage their own push subscriptions\n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write: if request.auth.uid == userId;\n      }\n    }\n\n    // Shifts can be read/updated by the assigned user or privileged users.\n    // Any authenticated user can create shifts (for admin import and testing).\n    // Only privileged users can delete shifts.\n    match /shifts/{shiftId} {\n        allow read, update: if request.auth.uid == resource.data.userId || isPrivileged(request.auth.uid);\n        allow create: if request.auth.uid != null;\n        allow delete: if isPrivileged(request.auth.uid);\n    }\n    \n    // Announcements can be read by any authenticated user.\n    // Only privileged users can create, update, or delete them.\n    match /announcements/{announcementId} {\n      allow read: if request.auth.uid != null;\n      allow write: if isPrivileged(request.auth.uid);\n    }\n    \n    // Health & Safety files can be read by any authenticated user.\n    // Only privileged users can write (create, update, delete).\n    match /health_and_safety_files/{fileId} {\n      allow read: if request.auth.uid != null;\n      allow write: if isPrivileged(request.auth.uid);\n    }\n\n    // Projects can be read by any authenticated user.\n    // Privileged users can create/write. All users can upload files to a project.\n    match /projects/{projectId} {\n      allow read: if request.auth.uid != null;\n      allow write: if isPrivileged(request.auth.uid);\n\n      // Rules for project-specific files\n      match /files/{fileId} {\n        // Any authenticated user can read files\n        allow read: if request.auth.uid != null;\n        // Anyone can create (upload) a file\n        allow create: if request.auth.uid != null;\n        // Only the uploader or a privileged user can delete a file\n        allow delete: if request.auth.uid == resource.data.uploaderId || isPrivileged(request.auth.uid);\n      }\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T20:53:41.018Z] Jul 05, 2025 8:53:41 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 8:53:41 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T20:53:41.305Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T20:53:41.305Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:19:40.486Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:19:40.487Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check for admin or owner roles\n    function isPrivilegedUser(userId) {\n      return get(/databases/$(database)/documents/users/$(userId)).data.role in ['admin', 'owner'];\n    }\n    \n    // Users can only read/update their own profile\n    match /users/{userId} {\n      allow get, update: if request.auth.uid == userId;\n      allow create: if request.auth.uid == userId;\n\n      // Admins/owners can read anyone's profile\n      allow list, get: if isPrivilegedUser(request.auth.uid);\n\n      // Push subscriptions can only be managed by the user themselves\n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write: if request.auth.uid == userId;\n      }\n    }\n\n    // Shifts can only be accessed by the assigned user or a privileged user\n    match /shifts/{shiftId} {\n        allow read, update, delete: if request.auth.uid == resource.data.userId || isPrivilegedUser(request.auth.uid);\n        allow create: if isPrivilegedUser(request.auth.uid);\n        // Privileged users can list all shifts for the schedule overview\n        allow list: if isPrivilegedUser(request.auth.uid);\n    }\n    \n    // Announcements can be read by anyone authenticated, created/updated by privileged users\n    match /announcements/{announcementId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if isPrivilegedUser(request.auth.uid);\n    }\n\n    // Projects can be read by anyone authenticated, created/updated by privileged users\n    match /projects/{projectId} {\n        allow read: if request.auth != null; \n        allow create, update, delete: if isPrivilegedUser(request.auth.uid);\n        \n        match /files/{fileId} {\n            allow read: if request.auth != null;\n            allow create: if request.auth != null;\n            allow delete: if request.auth.uid == resource.data.uploaderId || isPrivilegedUser(request.auth.uid);\n        }\n    }\n    \n    // Health and Safety files can be read by anyone, managed by privileged users\n    match /health_and_safety_files/{fileId} {\n        allow read: if request.auth != null;\n        allow create, delete: if isPrivilegedUser(request.auth.uid);\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:19:40.512Z] Jul 05, 2025 9:19:40 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:19:40 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:19:40.740Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:19:40.744Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:23:43.254Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:23:43.265Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /users/{userId} {\n      // Users can read their own profile\n      allow read: if request.auth != null && request.auth.uid == userId;\n      // Users can update their own profile, but not change their role\n      allow update: if request.auth != null && request.auth.uid == userId && request.resource.data.role == resource.data.role;\n      // Only owners can change roles\n      allow update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';\n      // New users can create their own profile document\n      allow create: if request.auth != null && request.auth.uid == userId;\n    }\n\n    match /users/{userId}/pushSubscriptions/{subscriptionId} {\n      allow read, write: if request.auth != null && request.auth.uid == userId;\n    }\n\n    match /shifts/{shiftId} {\n      // Admins/Owners can read/write all shifts\n      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n      // Users can only read shifts assigned to them\n      allow read: if request.auth != null && resource.data.userId == request.auth.uid;\n      // Users can update shifts assigned to them (e.g. status) but cannot change the user ID\n      allow update: if request.auth != null && resource.data.userId == request.auth.uid && request.resource.data.userId == resource.data.userId;\n    }\n\n    match /announcements/{announcementId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    match /projects/{projectId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n    \n    match /projects/{projectId}/files/{fileId} {\n      allow read: if request.auth != null;\n      // User who uploaded can delete. Admins/owners can also delete.\n      allow delete: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'] || resource.data.uploaderId == request.auth.uid);\n      // Anyone can upload files to a project\n      allow create: if request.auth != null;\n    }\n\n    // Rules for Health & Safety\n    match /health_and_safety_files {\n      // Allow any authenticated user to list the documents\n      allow list: if request.auth != null;\n      // Allow admins/owners to create new documents\n      allow create: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n    \n    match /health_and_safety_files/{fileId} {\n      // Allow any authenticated user to get a single document\n      allow get: if request.auth != null;\n      // Allow admins/owners to delete documents\n      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:23:43.282Z] Jul 05, 2025 9:23:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:23:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:23:43.649Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:23:43.654Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:25:46.468Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:25:46.468Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    function isPrivilegedUser() {\n      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow create: if request.auth.uid == userId;\n      allow update: if request.auth.uid == userId || isPrivilegedUser();\n    }\n    \n    match /users/{userId}/pushSubscriptions/{subscriptionId} {\n        allow read, write: if request.auth.uid == userId;\n    }\n\n    match /shifts/{shiftId} {\n      allow read: if request.auth.uid == resource.data.userId || isPrivilegedUser();\n      allow create: if isPrivilegedUser();\n      allow update: if request.auth.uid == resource.data.userId || isPrivilegedUser();\n      allow delete: if isPrivilegedUser();\n    }\n    \n    match /announcements/{announcementId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if isPrivilegedUser();\n    }\n\n    match /projects/{projectId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if isPrivilegedUser();\n    }\n\n    match /projects/{projectId}/files/{fileId} {\n        allow read: if request.auth != null;\n        allow create: if request.auth.uid == request.resource.data.uploaderId;\n        allow delete: if isPrivilegedUser() || request.auth.uid == resource.data.uploaderId;\n    }\n\n    match /health_and_safety_files/{fileId} {\n      // Explicitly allow list and get for any authenticated user.\n      allow list, get: if request.auth != null;\n      // Explicitly check role for create and delete operations.\n      allow create, delete: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:25:46.486Z] Jul 05, 2025 9:25:46 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:25:46 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:25:47.081Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:25:47.082Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:35:57.062Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:35:57.071Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // USER PROFILES\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow create: if request.auth.uid == userId;\n      // Allow user to update their own profile, or an owner to update any profile.\n      allow update: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';\n      \n      // Push Subscriptions can only be managed by the user they belong to.\n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write: if request.auth.uid == userId;\n      }\n    }\n\n    // SHIFTS\n    match /shifts/{shiftId} {\n        allow read: if request.auth != null;\n        // Only admins or owners can create, update, or delete shifts.\n        // A user can update their own shift (e.g., to change its status).\n        allow create, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n        allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'] || request.auth.uid == resource.data.userId;\n    }\n    \n    // PROJECTS\n    match /projects/{projectId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n        \n        // Project Files\n        match /files/{fileId} {\n            allow read: if request.auth != null;\n            allow create: if request.auth != null;\n            // Allow deletion by the uploader or an admin/owner.\n            allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'] || request.auth.uid == resource.data.uploaderId;\n        }\n    }\n\n    // ANNOUNCEMENTS\n    match /announcements/{announcementId} {\n        allow read: if request.auth != null;\n        allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n    \n    // HEALTH & SAFETY\n    match /health_and_safety_files/{fileId} {\n      // Any authenticated user can read (get, list) H&S files.\n      allow read: if request.auth != null;\n      // Only admins or owners can upload or delete H&S files.\n      allow create, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:35:57.096Z] Jul 05, 2025 9:35:57 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:35:57 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:35:57.401Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:35:57.404Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:39:30.028Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:39:30.029Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":""}]}}
[debug] [2025-07-05T21:39:30.047Z] Jul 05, 2025 9:39:30 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:39:30 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:39:30.355Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:39:30.356Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules"},"description":"Rules content empty. Compilation aborted.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:0:0 - ERROR Rules content empty. Compilation aborted. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:42:01.443Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:42:01.444Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    function isUser(userId) {\n      return request.auth != null && request.auth.uid == userId;\n    }\n\n    function isPrivilegedUser() {\n      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    match /users/{userId} {\n      // A user can read their own document\n      allow read: if isUser(userId);\n      // A user can update their own document\n      allow update: if isUser(userId);\n      // Any authenticated user can create their own document (signup)\n      allow create: if isUser(userId);\n      \n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write, delete: if isUser(userId);\n      }\n    }\n\n    match /shifts/{shiftId} {\n      // Privileged users can read/write any shift\n      allow read, write: if isPrivilegedUser();\n      // Users can only read/update their own shifts\n      allow read, update: if isUser(resource.data.userId);\n    }\n    \n    match /projects/{projectId} {\n      // Any authenticated user can read projects\n      allow read: if request.auth != null;\n      // Only privileged users can write to projects\n      allow write: if isPrivilegedUser();\n      \n      match /files/{fileId} {\n        // Any authenticated user can read project files\n        allow read: if request.auth != null;\n        // Any authenticated user can create project files\n        allow create: if request.auth != null;\n        // The uploader or a privileged user can delete/update\n        allow update, delete: if isUser(resource.data.uploaderId) || isPrivilegedUser();\n      }\n    }\n    \n    match /health_and_safety_files/{fileId} {\n      // Any authenticated user can read H&S files\n      allow read: if request.auth != null;\n      // Only privileged users can write H&S files\n      allow write: if isPrivilegedUser();\n    }\n    \n    match /announcements/{announcementId} {\n      // Any authenticated user can read announcements\n      allow read: if request.auth != null;\n      // Only privileged users can write announcements\n      allow write: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:42:01.485Z] Jul 05, 2025 9:42:01 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:42:01 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:42:01.837Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:42:01.839Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:44:14.984Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:44:14.990Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check for admin/owner role.\n    // This is now the single source of truth for privileged access.\n    function isPrivilegedUser() {\n      // Ensure the user is authenticated before trying to read their role.\n      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    // Rules for user profiles\n    match /users/{userId} {\n      // A user can read, create, and update their own profile.\n      allow read, update, create: if request.auth.uid == userId;\n\n      // The 'owner' can read and update any user profile, except for another owner's profile.\n      // This prevents an owner from being demoted.\n      allow read, update: if isPrivilegedUser() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner'\n                          && resource.data.role != 'owner';\n    }\n\n    // Rules for shifts\n    match /shifts/{shiftId} {\n      // An authenticated user can read any shift (for the team schedule view).\n      allow read: if request.auth.uid != null;\n\n      // A user can only update a shift if it is assigned to them.\n      allow update: if request.auth.uid == resource.data.userId;\n      \n      // Only privileged users can create or delete shifts.\n      allow create, delete: if isPrivilegedUser();\n    }\n\n    // Rules for projects and their nested files\n    match /projects/{projectId} {\n      // Any authenticated user can view project details.\n      allow read: if request.auth.uid != null;\n      \n      // Only privileged users can create, update, or delete projects.\n      allow create, update, delete: if isPrivilegedUser();\n\n      match /files/{fileId} {\n        // Any authenticated user can read and create files within a project.\n        allow read, create: if request.auth.uid != null;\n\n        // A file can be deleted by its uploader or by any privileged user.\n        allow delete: if isPrivilegedUser() || request.auth.uid == resource.data.uploaderId;\n      }\n    }\n\n    // Rules for company-wide announcements\n    match /announcements/{announcementId} {\n      // Any authenticated user can read announcements.\n      allow read: if request.auth.uid != null;\n      \n      // Only privileged users can create, update, or delete announcements.\n      allow create, update, delete: if isPrivilegedUser();\n    }\n\n    // Rules for Health & Safety documents\n    match /health_and_safety_files/{fileId} {\n      // Any authenticated user can read/list H&S files.\n      allow read: if request.auth.uid != null;\n      \n      // Only privileged users can upload (write) or delete H&S files.\n      allow write, delete: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:44:15.007Z] Jul 05, 2025 9:44:15 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:44:15 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:44:15.189Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:44:15.195Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:46:09.612Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:46:09.612Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // A user must be authenticated to perform any action.\n    // This is an implicit check in all subsequent rules.\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Checks if the authenticated user has the 'admin' or 'owner' role.\n    // This requires that the user can read their own profile document.\n    function isPrivilegedUser() {\n      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    // Users Collection\n    // - Allow users to read any profile (for name lookups).\n    // - Allow users to create their own user document upon signup.\n    // - Only owners can update roles.\n    // - Users can update their own profile.\n    match /users/{userId} {\n      allow read: if isAuthenticated();\n      allow create: if request.auth.uid == userId;\n      allow update: if request.auth.uid == userId || isPrivilegedUser();\n      \n      // Push Subscriptions Subcollection\n      // A user can only manage their own notification subscriptions.\n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write, delete: if isAuthenticated() && request.auth.uid == userId;\n      }\n    }\n\n    // Shifts Collection\n    // - All authenticated users can read shifts.\n    // - Any user can update a shift assigned to them (to change its status).\n    // - Only privileged users can create, fully update, or delete any shift.\n    match /shifts/{shiftId} {\n      allow read: if isAuthenticated();\n      allow create, delete: if isPrivilegedUser();\n      allow update: if isPrivilegedUser() || (isAuthenticated() && request.auth.uid == resource.data.userId);\n    }\n\n    // Announcements Collection\n    // - All authenticated users can read announcements.\n    // - Only privileged users can create, update, or delete announcements.\n    match /announcements/{announcementId} {\n      allow read: if isAuthenticated();\n      allow create, update, delete: if isPrivilegedUser();\n    }\n\n    // Projects Collection\n    // - All authenticated users can read project details.\n    // - Only privileged users can create, update, or delete projects.\n    match /projects/{projectId} {\n      allow read: if isAuthenticated();\n      allow create, update, delete: if isPrivilegedUser();\n\n      // Project Files Subcollection\n      // - All authenticated users can read and upload files to any project.\n      // - Users can only delete their own files, but privileged users can delete any file.\n      match /files/{fileId} {\n        allow read, create: if isAuthenticated();\n        allow delete: if (isAuthenticated() && request.auth.uid == resource.data.uploaderId) || isPrivilegedUser();\n      }\n    }\n\n    // Health & Safety Files Collection\n    // - All authenticated users can read (list and get) H&S files.\n    // - Only privileged users can upload or delete H&S files.\n    match /health_and_safety_files/{fileId} {\n      allow read: if isAuthenticated();\n      allow create, delete: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:46:09.629Z] Jul 05, 2025 9:46:09 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:46:09 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:46:09.828Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:46:09.829Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T21:48:40.502Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T21:48:40.502Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // A user must be authenticated to perform any action.\n    // This is an implicit check in all subsequent rules.\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Checks if the authenticated user has the 'admin' or 'owner' role.\n    // This function is now robust, checking for document existence before access.\n    function isPrivilegedUser() {\n      return isAuthenticated() &&\n             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&\n             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    // Users Collection\n    // - Allow users to read any profile (for name lookups).\n    // - Allow users to create their own user document upon signup.\n    // - Only owners can update roles.\n    // - Users can update their own profile.\n    match /users/{userId} {\n      allow read: if isAuthenticated();\n      allow create: if request.auth.uid == userId;\n      allow update: if request.auth.uid == userId || isPrivilegedUser();\n      \n      // Push Subscriptions Subcollection\n      // A user can only manage their own notification subscriptions.\n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write, delete: if isAuthenticated() && request.auth.uid == userId;\n      }\n    }\n\n    // Shifts Collection\n    // - All authenticated users can read shifts.\n    // - Any user can update a shift assigned to them (to change its status).\n    // - Only privileged users can create, fully update, or delete any shift.\n    match /shifts/{shiftId} {\n      allow read: if isAuthenticated();\n      allow create, delete: if isPrivilegedUser();\n      allow update: if isPrivilegedUser() || (isAuthenticated() && request.auth.uid == resource.data.userId);\n    }\n\n    // Announcements Collection\n    // - All authenticated users can read announcements.\n    // - Only privileged users can create, update, or delete announcements.\n    match /announcements/{announcementId} {\n      allow read: if isAuthenticated();\n      allow create, update, delete: if isPrivilegedUser();\n    }\n\n    // Projects Collection\n    // - All authenticated users can read project details.\n    // - Only privileged users can create, update, or delete projects.\n    match /projects/{projectId} {\n      allow read: if isAuthenticated();\n      allow create, update, delete: if isPrivilegedUser();\n\n      // Project Files Subcollection\n      // - All authenticated users can read and upload files to any project.\n      // - Users can only delete their own files, but privileged users can delete any file.\n      match /files/{fileId} {\n        allow read, create: if isAuthenticated();\n        allow delete: if (isAuthenticated() && request.auth.uid == resource.data.uploaderId) || isPrivilegedUser();\n      }\n    }\n\n    // Health & Safety Files Collection\n    // - All authenticated users can read (list and get) H&S files.\n    // - Only privileged users can upload or delete H&S files.\n    match /health_and_safety_files/{fileId} {\n      allow read: if isAuthenticated();\n      allow create, delete: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T21:48:40.537Z] Jul 05, 2025 9:48:40 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:48:40 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T21:48:40.826Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T21:48:40.829Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[debug] [2025-07-05T21:59:52.691Z] Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-07-05T21:59:52.715Z] Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-07-05T21:59:52.844Z] Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T21:59:52.971Z] Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 9:59:52 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T22:00:09.275Z] Jul 05, 2025 10:00:09 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:00:09 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T22:00:09.602Z] Jul 05, 2025 10:00:09 PM io.grpc.netty.NettyServerTransport notifyTerminated
INFO: Transport failed
io.netty.handler.codec.http2.Http2Exception: Unexpected HTTP/1.x request: GET / 
	at io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:315)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)
	at io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:1583)

 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:00:09 PM io.grpc.netty.NettyServerTransport notifyTerminated\nINFO: Transport failed\nio.netty.handler.codec.http2.Http2Exception: Unexpected HTTP/1.x request: GET / \n\tat io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:315)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)\n\tat io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)\n\tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n\n"}}
[debug] [2025-07-05T22:00:10.006Z] Jul 05, 2025 10:00:09 PM io.grpc.netty.NettyServerTransport notifyTerminated
INFO: Transport failed
io.netty.handler.codec.http2.Http2Exception: HTTP/2 client preface string missing or corrupt. Hex dump for received bytes: 16030105a8010005a40303933d7414d463d9cb26b856c882
	at io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:319)
	at io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)
	at io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:1583)

 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:00:09 PM io.grpc.netty.NettyServerTransport notifyTerminated\nINFO: Transport failed\nio.netty.handler.codec.http2.Http2Exception: HTTP/2 client preface string missing or corrupt. Hex dump for received bytes: 16030105a8010005a40303933d7414d463d9cb26b856c882\n\tat io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:107)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.readClientPrefaceString(Http2ConnectionHandler.java:319)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler$PrefaceDecoder.decode(Http2ConnectionHandler.java:245)\n\tat io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:451)\n\tat io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)\n\tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1407)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:918)\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n\n"}}
[debug] [2025-07-05T22:00:10.057Z] Jul 05, 2025 10:00:10 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:00:10 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T22:00:10.452Z] Jul 05, 2025 10:00:10 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:00:10 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-07-05T22:01:55.513Z] Jul 05, 2025 10:01:55 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:01:55 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-07-05T22:01:55.580Z] Jul 05, 2025 10:01:55 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:01:55 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-07-05T22:01:55.632Z] Jul 05, 2025 10:01:55 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:01:55 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T22:36:43.822Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T22:36:43.827Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Checks if the authenticated user has a document in the users collection.\n    // This is crucial to prevent errors when checking for a user's role.\n    function userExists() {\n      return exists(/databases/$(database)/documents/users/$(request.auth.uid));\n    }\n\n    // Checks if the authenticated user has the 'admin' or 'owner' role.\n    // This is now safe and will not cause errors if the user document doesn't exist.\n    function isPrivilegedUser() {\n      return request.auth != null && userExists() &&\n             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    // Users Collection\n    // - Allow users to read any profile (for name lookups in the app).\n    // - Allow users to create their own user document upon signup.\n    // - Only owners can update roles of other users.\n    // - Users can update their own profile.\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow create: if request.auth.uid == userId;\n      allow update: if request.auth.uid == userId || isPrivilegedUser();\n      \n      // Push Subscriptions Subcollection\n      // A user can only manage their own notification subscriptions.\n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write, delete: if request.auth != null && request.auth.uid == userId;\n      }\n    }\n\n    // Shifts Collection\n    // - All authenticated users can read shifts.\n    // - Any user can update a shift assigned to them (to change its status).\n    // - Only privileged users can create, fully update, or delete any shift.\n    match /shifts/{shiftId} {\n      allow read: if request.auth != null;\n      allow create, delete: if isPrivilegedUser();\n      allow update: if isPrivilegedUser() || (request.auth != null && request.auth.uid == resource.data.userId);\n    }\n\n    // Announcements Collection\n    // - All authenticated users can read announcements.\n    // - Only privileged users can create, update, or delete announcements.\n    match /announcements/{announcementId} {\n      allow read: if request.auth != null;\n      allow create, update, delete: if isPrivilegedUser();\n    }\n\n    // Projects Collection\n    // - All authenticated users can read project details.\n    // - Only privileged users can create, update, or delete projects.\n    match /projects/{projectId} {\n      allow read: if request.auth != null;\n      allow create, update, delete: if isPrivilegedUser();\n\n      // Project Files Subcollection\n      // - All authenticated users can read files from any project.\n      // - Users can upload files to any project.\n      // - Users can only delete their own files, but privileged users can delete any file.\n      match /files/{fileId} {\n        allow read, create: if request.auth != null;\n        allow delete: if (request.auth != null && request.auth.uid == resource.data.uploaderId) || isPrivilegedUser();\n      }\n    }\n\n    // Health & Safety Files Collection\n    // - All authenticated users can read (list and get) H&S files.\n    // - Only privileged users can upload or delete H&S files.\n    match /health_and_safety_files/{fileId} {\n      allow read: if request.auth != null;\n      allow create, delete: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T22:36:43.867Z] Jul 05, 2025 10:36:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:36:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T22:36:43.891Z] Jul 05, 2025 10:36:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:36:43 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-07-05T22:36:44.111Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T22:36:44.117Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-07-05T22:39:28.094Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-07-05T22:39:28.094Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // A user must be authenticated to perform any action.\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Checks if the authenticated user has the 'admin' or 'owner' role.\n    // This is now written safely to prevent errors if the user doc doesn't exist.\n    function isPrivilegedUser() {\n      return isAuthenticated() &&\n             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&\n             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];\n    }\n\n    // Users Collection\n    match /users/{userId} {\n      allow read: if isAuthenticated();\n      allow create: if request.auth.uid == userId;\n      allow update: if request.auth.uid == userId || isPrivilegedUser();\n      \n      match /pushSubscriptions/{subscriptionId} {\n        allow read, write, delete: if isAuthenticated() && request.auth.uid == userId;\n      }\n    }\n\n    // Shifts Collection\n    match /shifts/{shiftId} {\n      allow read: if isAuthenticated();\n      allow create, delete: if isPrivilegedUser();\n      allow update: if isPrivilegedUser() || (isAuthenticated() && request.auth.uid == resource.data.userId);\n    }\n\n    // Announcements Collection\n    match /announcements/{announcementId} {\n      allow read: if isAuthenticated();\n      allow create, update, delete: if isPrivilegedUser();\n    }\n\n    // Projects Collection\n    match /projects/{projectId} {\n      allow read: if isAuthenticated();\n      allow create, update, delete: if isPrivilegedUser();\n\n      match /files/{fileId} {\n        allow read, create: if isAuthenticated();\n        allow delete: if (isAuthenticated() && request.auth.uid == resource.data.uploaderId) || isPrivilegedUser();\n      }\n    }\n\n    // Health & Safety Files Collection\n    // The create rule is simplified to allow any authenticated user to upload.\n    match /health_and_safety_files/{fileId} {\n      allow read: if isAuthenticated();\n      allow create: if isAuthenticated(); // CHANGED: Simplified rule to fix upload.\n      allow delete: if isPrivilegedUser();\n    }\n  }\n}\n"}]}}
[debug] [2025-07-05T22:39:28.130Z] Jul 05, 2025 10:39:28 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jul 05, 2025 10:39:28 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-07-05T22:39:28.543Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-07-05T22:39:28.547Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 

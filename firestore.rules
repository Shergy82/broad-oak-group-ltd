rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for changes in a map, ignoring specific keys
    function changedKeys(map1, map2) {
      return map1.keys().diff(map2.keys());
    }
    
    // Helper function to check if only the 'viewedBy' field is being modified
    function onlyViewedByIsUpdated() {
        let otherFields = ['title', 'content', 'authorName', 'authorId', 'createdAt', 'updatedAt'];
        let changed = false;
        for (let field in otherFields) {
            if (resource.data[field] != request.resource.data[field]) {
                changed = true;
            }
        }
        return !changed;
    }

    match /users/{userId} {
      // Any authenticated user can create their own user profile document.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Only the authenticated user can read or update their own profile.
      // Admins and owners can also read any user's profile.
      allow read, update: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner']);
    }

    match /announcements/{announcementId} {
      // Any authenticated user can read announcements.
      allow read: if request.auth != null;

      // Only admins or owners can create, update the content of, or delete announcements.
      // We check that the creator is who they say they are.
      allow create: if request.auth != null 
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner']
                    && request.resource.data.authorId == request.auth.uid;
      
      // Admins/owners can update any part of the announcement.
      allow update: if request.auth != null 
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
      
      // A regular user can ALSO update an announcement, BUT ONLY to add themselves to the 'viewedBy' map.
      // This is the rule that allows the "Acknowledge" feature to work for everyone.
      allow update: if request.auth != null
                    // Rule 1: The incoming data for 'viewedBy' must be a map.
                    && request.resource.data.viewedBy is map
                    // Rule 2: The user's own UID must be a key in the new 'viewedBy' map.
                    && request.auth.uid in request.resource.data.viewedBy.keys()
                    // Rule 3: The value for the user's UID must be a timestamp.
                    && request.resource.data.viewedBy[request.auth.uid] is timestamp
                    // Rule 4: Check that the user is not trying to modify any other user's viewed status.
                    // The only difference between the old `viewedBy` keys and the new one should be the current user's UID.
                    && changedKeys(request.resource.data.viewedBy, resource.data.viewedBy).size() == 1
                    && changedKeys(request.resource.data.viewedBy, resource.data.viewedBy)[0] == request.auth.uid
                    // Rule 5: Ensure no other fields (like title or content) are being changed at the same time.
                    && onlyViewedByIsUpdated();

      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
    }

    match /shifts/{shiftId} {
      // An authenticated user can read shifts if they are the assigned user OR they are an admin/owner.
      allow read: if request.auth != null 
                  && (request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner']);

      // The assigned user can update their own shift (e.g., to change status).
      // Admins/owners can also update any shift.
      allow update: if request.auth != null 
                  && (request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner']);

      // Only an admin or owner can create or delete shifts.
      allow create, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
    }
    
    match /projects/{projectId} {
        // Any authenticated user can read project details.
        allow read: if request.auth != null;
        
        // Only admins/owners can create or delete projects.
        allow create, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
        
        // Files subcollection
        match /files/{fileId} {
            allow read: if request.auth != null;
            allow create: if request.auth != null; // File uploads are allowed for any logged-in user.
            
            // Deletion is handled by the Cloud Function which has its own permission checks.
            allow delete: if request.auth != null; 
        }
    }
    
    // Settings can only be read/written by the owner, via Cloud Functions.
    match /settings/{settingId} {
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }

    match /users/{userId}/pushSubscriptions/{subscriptionId} {
        // A user can only manage their own push subscriptions.
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}

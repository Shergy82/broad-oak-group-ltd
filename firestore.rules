rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper function to check for admin/owner roles ---
    function isPrivilegedUser(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role in ['admin', 'owner'];
    }

    // --- Users Collection ---
    // - Users can read their own profile.
    // - Authenticated users can create their own user document upon signup.
    // - Only owners can update user roles. Other users can't update any part of any profile.
    // - Only owners can delete users.
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      allow update: if isPrivilegedUser(request.auth.uid) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
      allow delete: if isPrivilegedUser(request.auth.uid) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }

    // --- Shifts Collection ---
    // - Authenticated users can read shifts assigned to them.
    // - Admins/owners can read all shifts.
    // - Authenticated users can update the status of their own shifts.
    // - Admins/owners can create, update, and delete any shifts.
    match /shifts/{shiftId} {
      allow read: if request.auth.uid == resource.data.userId || isPrivilegedUser(request.auth.uid);
      allow update: if request.auth.uid == resource.data.userId || isPrivilegedUser(request.auth.uid);
      allow create, delete: if isPrivilegedUser(request.auth.uid);
    }
    
    // --- Projects Collection ---
    // - All authenticated users can read all projects and their file listings.
    // - Only admins/owners can create, update, or delete projects.
    match /projects/{projectId} {
      allow read: if request.auth.uid != null;
      allow create, update: if isPrivilegedUser(request.auth.uid);
      
      // Deleting a project document will recursively delete the 'files' subcollection.
      allow delete: if isPrivilegedUser(request.auth.uid);

      // --- Project Files Subcollection ---
      // - Authenticated users can read file listings.
      // - Any authenticated user can create (upload) a file.
      // - Only the uploader or an admin/owner can delete a file (deletion is handled by a Cloud Function).
      match /files/{fileId} {
        allow get, list: if request.auth.uid != null;
        allow create: if request.auth.uid != null;
        // Deletion is handled by the `deleteProjectFile` Cloud Function, which enforces permissions.
        allow delete: if false; 
      }
    }

    // --- Announcements Collection ---
    match /announcements/{announcementId} {
      // Any authenticated user can read announcements and see who has acknowledged them.
      allow get, list;
      
      // Only admins/owners can create or update announcements.
      allow create, update: if isPrivilegedUser(request.auth.uid);
      
      // Admins/owners can delete an announcement. This rule enables recursive deletion
      // of the 'acknowledgedBy' subcollection.
      allow delete: if isPrivilegedUser(request.auth.uid);

      // --- Acknowledgements Subcollection ---
      match /acknowledgedBy/{userId} {
          // A user can read anyone's acknowledgement (for the admin viewer).
          allow get, list: if isPrivilegedUser(request.auth.uid);
          // A user can only create an acknowledgement for themselves. They cannot update or delete it.
          allow create: if request.auth.uid == userId;
          allow update, delete: if false;
      }
    }
    
    // --- Settings Collection ---
    // Only the owner can read or write to the global settings.
    match /settings/{settingId} {
        allow read, write: if isPrivilegedUser(request.auth.uid) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }
  }
}

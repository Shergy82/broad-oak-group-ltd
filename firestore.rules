rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check user role
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    function isOneOfRoles(roles) {
      let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return userRole in roles;
    }

    // Users:
    // - Anyone can create their own user document on signup.
    // - Users can only read/update their own profile.
    // - Admins/Owners can read all user profiles.
    // - Only owners can update other users' roles.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isOneOfRoles(['admin', 'owner']));
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow role updates only by owner, but don't let them change their own role.
      allow update: if request.auth != null && (
        (request.auth.uid == userId && !("role" in request.resource.data)) ||
        (isRole('owner') && resource.data.role != 'owner')
      );
    }
    
    // Push Subscriptions:
    // Users can create and delete their own push notification subscriptions.
    match /users/{userId}/pushSubscriptions/{subscriptionId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Settings:
    // Only the owner can read or write global settings.
    match /settings/{settingId} {
      allow read, write: if request.auth != null && isRole('owner');
    }

    // Shifts:
    // - Authenticated users can read their own shifts.
    // - Admins/Owners can read all shifts.
    // - Users can create/update their own shifts (e.g. for status changes).
    // - Admins/Owners can create/update/delete any shift.
    match /shifts/{shiftId} {
      allow read, update: if request.auth != null && (resource.data.userId == request.auth.uid || isOneOfRoles(['admin', 'owner']));
      allow create, delete: if request.auth != null && isOneOfRoles(['admin', 'owner']);
    }

    // Announcements:
    // - Any authenticated user can read announcements.
    // - Only admins/owners can create, update, or delete announcements.
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isOneOfRoles(['admin', 'owner']);

      // Acknowledgements Subcollection:
      // - A user can create an acknowledgement for themselves.
      // - Admins/Owners can read the acknowledgements.
      match /acknowledgedBy/{userId} {
        allow read: if request.auth != null && isOneOfRoles(['admin', 'owner']);
        allow create: if request.auth != null && request.auth.uid == userId;
        allow write: if false; // No updates or deletes allowed
      }
    }

    // Projects & Files:
    // - Any authenticated user can read projects and their file lists.
    // - Any authenticated user can create (upload) files to any project.
    // - Users can only delete files they uploaded themselves.
    // - Admins/Owners can create/delete any project and any file.
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && isOneOfRoles(['admin', 'owner']);
      
      match /files/{fileId} {
        allow read, create: if request.auth != null;
        allow update: if false; // Disallow updates to file documents
        allow delete: if request.auth != null && (
          resource.data.uploaderId == request.auth.uid || isOneOfRoles(['admin', 'owner'])
        );
      }
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get a user's role from their profile
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    // Helper function to check if a user is an admin or owner
    function isPrivilegedUser(userId) {
      let role = getUserRole(userId);
      return role == 'admin' || role == 'owner';
    }
    
    // Users can read any profile, but only edit their own.
    // Admins can edit any profile. Owners can't be demoted.
    match /users/{userId} {
      allow read: if request.auth.uid != null;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || (isPrivilegedUser(request.auth.uid) && getUserRole(userId) != 'owner');
    }

    // Shifts can be read by any user.
    // They are created/updated/deleted by admins/owners.
    // An assigned user can update their own shift's status.
    match /shifts/{shiftId} {
      allow read: if request.auth.uid != null;
      allow create, delete: if isPrivilegedUser(request.auth.uid);
      allow update: if isPrivilegedUser(request.auth.uid) || request.auth.uid == resource.data.userId;
    }

    // Projects can be read by any user.
    // They are managed by admins/owners.
    match /projects/{projectId} {
      allow read: if request.auth.uid != null;
      allow create, update, delete: if isPrivilegedUser(request.auth.uid);

      // Files within a project can be read by anyone.
      // Any authenticated user can upload a file to a project.
      // Only the uploader or an admin can delete a file.
      match /files/{fileId} {
        allow read: if request.auth.uid != null;
        allow create: if request.auth.uid != null;
        allow delete: if isPrivilegedUser(request.auth.uid) || request.auth.uid == resource.data.uploaderId;
      }
    }
    
    // Announcements can be read by any user.
    // They are managed by admins/owners.
    match /announcements/{announcementId} {
        allow read: if request.auth.uid != null;
        allow create, update, delete: if isPrivilegedUser(request.auth.uid);
    }
    
    // Health & Safety files can be read by any user.
    // They can only be created or deleted by admins/owners.
    match /health_and_safety_files/{fileId} {
        allow read: if request.auth.uid != null;
        allow create, delete: if isPrivilegedUser(request.auth.uid);
    }
  }
}
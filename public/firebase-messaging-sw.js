
// DO NOT EDIT THIS FILE
// This file is a service worker that is used to handle push notifications.
// It is automatically generated by the build process.

importScripts("https://www.gstatic.com/firebasejs/9.2.0/firebase-app-compat.js");
importScripts("https://www.gstatic.com/firebasejs/9.2.0/firebase-messaging-compat.js");

self.addEventListener('install', function (e) {
  console.log('Service Worker: Installed');
});

self.addEventListener('activate', function (e) {
  console.log('Service Worker: Activated');
});

self.addEventListener('fetch', function (event) {
  // This service worker is primarily for push notifications,
  // so we won't intercept fetch requests.
});

// Parse the config from the query string
const urlParams = new URL(location).searchParams;
const firebaseConfigStr = urlParams.get('firebaseConfig');

if (firebaseConfigStr) {
  try {
    const firebaseConfig = JSON.parse(decodeURIComponent(firebaseConfigStr));
    if (firebase.apps.length === 0) {
      firebase.initializeApp(firebaseConfig);
      const messaging = firebase.messaging();

      messaging.onBackgroundMessage((payload) => {
        console.log('[firebase-messaging-sw.js] Received background message ', payload);
        
        const notificationTitle = payload.data.title;
        const notificationOptions = {
          body: payload.data.body,
          icon: '/icon-192.png',
          data: {
            url: payload.data.url
          }
        };

        self.registration.showNotification(notificationTitle, notificationOptions);
      });
    }
  } catch (e) {
    console.error('Failed to initialize Firebase in service worker:', e);
  }
} else {
    console.error("Firebase config not found in service worker query string.");
}

self.addEventListener('notificationclick', function(event) {
  event.notification.close();
  const urlToOpen = event.notification.data.url || '/';

  event.waitUntil(
    clients.matchAll({
      type: 'window',
      includeUncontrolled: true
    }).then(function(windowClients) {
      // Check if there is already a window/tab open with the target URL
      for (var i = 0; i < windowClients.length; i++) {
        var client = windowClients[i];
        if (client.url === urlToOpen && 'focus' in client) {
          return client.focus();
        }
      }
      // If not, then open a new window
      if (clients.openWindow) {
        return clients.openWindow(urlToOpen);
      }
    })
  );
});

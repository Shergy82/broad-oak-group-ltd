rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to get user's role from their profile document
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // USERS
    // Users can read their own profile.
    // Users can create their own profile upon signup.
    // Only admins/owners can update other user profiles (except for their own role).
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      
      // Allow user to update their own profile, but not their role.
      allow update: if request.auth.uid == userId
                      && !("role" in request.resource.data);
                      
      // Allow admins/owners to update other users, but not change an owner's role.
      allow update: if getUserRole(request.auth.uid) in ['admin', 'owner']
                      && resource.data.role != 'owner';
    }
    
    // PUSH SUBSCRIPTIONS
    // Users can only manage their own push notification subscriptions.
    match /users/{userId}/pushSubscriptions/{subscriptionId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // SETTINGS
    match /settings/{docId} {
      // Any authenticated user can read settings (e.g., to see if notifications are enabled).
      allow read: if request.auth != null;
      // Writes are handled by a secure Cloud Function, so no direct client writes are allowed.
      allow write: if false; 
    }

    // SHIFTS
    // Users can read their own shifts.
    // Admins/owners can read all shifts.
    // Admins/owners can create/delete shifts.
    // Users can update the status of their own shifts.
    match /shifts/{shiftId} {
      allow read: if request.auth.uid == resource.data.userId 
                  || getUserRole(request.auth.uid) in ['admin', 'owner'];
                  
      allow create, delete: if getUserRole(request.auth.uid) in ['admin', 'owner'];
      
      // Allow users to update specific fields (status, notes) on their own shifts.
      allow update: if request.auth.uid == resource.data.userId
                     && request.resource.data.keys().hasAll(['status', 'notes'])
                     && request.resource.data.size() == 2;
                     
      // Allow admins/owners to update any field on any shift.
      allow update: if getUserRole(request.auth.uid) in ['admin', 'owner'];
    }
    
    // PROJECTS
    // All authenticated users can read all projects.
    // Only admins/owners can create/delete/update projects.
    match /projects/{projectId} {
       allow read: if request.auth != null;
       allow write: if getUserRole(request.auth.uid) in ['admin', 'owner'];
    }
    
    // PROJECT FILES
    // All authenticated users can read all project files.
    // Any user can create (upload) a file.
    // Users can delete their own files. Admins/owners can delete any file.
    match /projects/{projectId}/files/{fileId} {
        allow read, create: if request.auth != null;
        allow delete: if request.auth.uid == resource.data.uploaderId
                      || getUserRole(request.auth.uid) in ['admin', 'owner'];
    }
    
    // ANNOUNCEMENTS
    // All authenticated users can read announcements.
    // Only admins/owners can create/update/delete them.
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow write: if getUserRole(request.auth.uid) in ['admin', 'owner'];
    }
    
  }
}
